---
title: "Staypoint estimate analysis"
output:
  workflowr::wflow_html
---


# Determine which staypoint parameters work the best

## staypoint parameters 
The staypoint determination algorithm uses 4 variables;
 - min_staypoint_time  - minimum time, in minutes, that must stay within max_staypoint_distance
 * max_jump_time - maximum time, in minutes, between readings
 * max_staypoint_distance - maximum distance for readings to be counted as a single staypoint
 * max_speed_filter - noise reduction parameter, eliminating points that would take over this speed to get there (in kmh)

## Tests for good staypoint parameters

 - See if they match the survey data timestamps - we assume that survey data timestamps correspond to staypoints
 * see if they match drinking establishment locations
 * see if they match home locations - todo later 4 

```{r results='hide', message=FALSE, warning=FALSE, cache=FALSE}
options(warn=-1)
library( knitr )
opts_chunk$set(cache=TRUE, autodep=TRUE)

source('lib/functions.R')
source('lib/get_data.R')
source('lib/location_prep.R')
source('lib/gps_functions.R')
library(tidyverse)
library(lubridate)



```

```{r load_data_cacheable, cache=TRUE}


# load in the individual locations information
df_location = get_df_location()

# load in the best guess location information
df_best_location = get_df_best_location( df_location )



# get survey data
df_all = get_df_all()

# get survey timestamps
df_all_ts = get_df_all_ts( df_all )

```

# determine home locations
 - For each person, if they have more than one night's reading, if the centroid of the first 10 points of each night is in the same vicinity, this is their home
 - Vicinity is 20 m 
 - Doesn't work, too much noise


```{r find_homes, eval=FALSE}

df_best_location %>%
  filter( accuracy <30) %>%
  group_by( userid, night) %>%
  do( head(., 2 )) %>%
  summarise( latitude = median( latitude), longitude = mean( longitude) ) %>%
  filter( n()>1) %>% 
  ungroup() %>%
  { . } -> df_home_centroids


df_home_centroids %>%
  group_by( userid ) %>%
  summarise( latitude = median( latitude), longitude = mean( longitude) ) %>% 
  ungroup() %>%
  { . } -> df_estimated_home


debug( calculate_distance)

df_home_centroids %>%
  inner_join( df_estimated_home, by='userid') %>%
  mutate( distance = geo_dist_pairs( longitude.x,latitude.x, longitude.y[1], latitude.y[1] )) %>% 
  { . } -> a


a %>% 
  filter( distance < 1) 


a %>%
  ggplot( ) + geom_histogram( aes( distance, color=userid))


```

# Bar Locations - calculate and clean input



```{r explore_locations}


read_csv( 'data/foursquare_locations_data_ls.csv') %>%
  bind_rows( read_csv( 'data/foursquare_locations_data_zh.csv')) %>% 
  { . } -> df_4sq_locations


source('lib/bad_categories.R')
source('lib/restaurant_categories.R')
df_type = tribble(
                  ~primaryCategory, ~type,
                  'Subway', 'transport',
                  'Train', 'transport',
                  'Train Station', 'transport',
                  'Light Rail', 'transport',
                  'Platform', 'transport',
                  'Parking', 'transport',
                  'Field', 'park',
                  'Park', 'park',
                  'Plaza', 'park',
                  'Plaza / Square', 'park',
                  'Comedy Club', 'theater',
                  'Concert Hall', 'theater',
				  'Music Venue', 'theater',
				  'Movie Theater', 'theater',
                  'Cineplex', 'theater',
                  'Theater', 'theater')

alcohol_venue_types = c("Bar", "Nightclub", "Lounge", "Pub", "Wine Bar", "Gay Bar",
  "Nightlife", "Sports Bar", "Jazz Club", "Brewery", "Karaoke",
  "Liquor Store", "Rock Club", "Festival", "Whisky Bar")

df_4sq_locations %>%
  count( primaryCategory, sort=TRUE) 


df_4sq_locations %>%
  filter( !primaryCategory %in% bad_categories ) %>%
  mutate( primaryCategory = ifelse( primaryCategory %in% restaurant_categories, 'food', primaryCategory)) %>%
  left_join( df_type, by='primaryCategory') %>%
  mutate( type=ifelse( is.na(type), primaryCategory, type)) %>%
  mutate( type=ifelse( type %in% alcohol_venue_types, 'alcohol', type)) %>%
  group_by( shortUrl,  primaryCategory, type ) %>%
  summarise( name=min(name), 
			  checkinsCount = max( checkinsCount),
			  latitude=mean(latitude), 
			  longitude=mean(longitude) 
) %>%
  ungroup() %>%
  {.} -> df_4sq_locations_filtered



df_4sq_locations_filtered %>%
  count( type, sort=TRUE ) 

df_4sq_locations_filtered %>%
count( shortUrl, sort=TRUE ) %>%
head( 10 )  
 
```


# Staypoint evaluation

For each proposed stay point, is there a bar location that is within 50M of the centroid of the proposed staypoint?

```{r evaluate_staypoints_geography}

row= tribble( ~filename,'data/save_1200_1200_10_20_.rds')
#undebug( analyse_staypoint_set_geography )
#debug( analyse_staypoint_set_geography )

#********************************************************************************
#analyse_staypoint_set_geography 
#********************************************************************************
analyse_staypoint_set_geography <- function( row ) {
  

  readRDS(row$filename) -> df
  cat(row$filename)
  cat("\n")

  df %>% 
    filter( n_staypoint > 0 ) %>%
    group_by( userid, night, n_staypoint) %>%
    summarise( latitude = mean( latitude), longitude  = mean( longitude)) %>% 
    ungroup() %>%
    { . } -> a

  


  a %>% 
    group_by( userid, night) %>%
    summarise( n=n()) %>%
    ungroup() %>%
    summarise( n_staypoint = nrow(a), mean_sp_night=mean(n), max_sp_night=max(n), sd_sp_night=sd(n)) %>% 
    bind_cols( row ) %>%
    { . } -> summary_stats

  a %>%
    geo_inner_join(df_4sq_locations_filtered, max_dist = .02, distance_col='dist') %>% 
    { . } -> b

  b %>% 
    mutate( dist = round( dist * 1000, 0)) %>%
    group_by( userid, night, n_staypoint ) %>% 
    arrange( dist , type) %>%
    do( head(., 1)) %>%
    ungroup() %>%
    { . } -> d

  d %>% 
    count( type, sort=TRUE) %>%
    spread(type, n) %>%
    bind_cols(summary_stats) %>%
    bind_cols (enframe( nrow(d), value='nhits')) %>%
    select(  nhits, everything() ) %>%
    select( -name )

}


list.files( path='data/', pattern='save.*rds', full.names=TRUE ) %>%
  enframe(value = 'filename' ) %>%
  separate( col=filename, 
           into=c(NA, qc(min_staypoint_time, max_jump_time, max_staypoint_distance, max_speed_filter)), 
           sep='_', 
           extra='drop' ,
           remove=FALSE)  %>%
  select( min_staypoint_time, max_jump_time, max_staypoint_distance, max_speed_filter, everything() ) %>%
  mutate_at(1:4, function(x) {sprintf('%06.1f', as.numeric(x) ) }) %>%
  rowwise() %>%
  do( analyse_staypoint_set_geography(.) ) %>% 
  { . } -> rv


rv %>%
  ggplot( aes(x=(max_jump_time), y=nhits, fill=(max_jump_time) )) +
  geom_boxplot()

rv %>%
  ggplot( aes(x=(max_staypoint_distance), y=nhits, fill=( max_staypoint_distance) )) +
  geom_boxplot()

rv %>%
  ggplot( aes(x=(max_speed_filter), y=nhits, fill=( max_speed_filter) )) +
  geom_boxplot()

rv %>%
  ggplot( aes(x=(min_staypoint_time), y=nhits/n_staypoint, fill=( min_staypoint_time) )) +
  geom_boxplot()

rv %>%
  ggplot( aes(x=(max_jump_time), y=nhits/n_staypoint, fill=(max_jump_time) )) +
  geom_boxplot()

rv %>%
  ggplot( aes(x=(max_staypoint_distance), y=nhits/n_staypoint, fill=( max_staypoint_distance) )) +
  geom_boxplot()

rv %>%
  ggplot( aes(x=(max_speed_filter), y=nhits/n_staypoint, fill=( max_speed_filter) )) +
  geom_boxplot()

rv %>%
  ggplot( aes(x=(min_staypoint_time), y=nhits/n_staypoint, fill=( min_staypoint_time) )) +
  geom_boxplot()


rv %>%
  ggplot( aes(x=(min_staypoint_time), y=nhits/n_staypoint, fill=( min_staypoint_time) )) +
  geom_boxplot() + 
  facet_wrap( .~max_staypoint_distance)


```

# Method - Evaluating staypoint discovery due  to survey timestamp

For each person, take all their survey timestamps;  match them against all the staypoint timestamps, with a 300second leeway. 



```{r analyse_staypoint_set_time}

df_all_ts  %>%
  group_by( userid, night ) %>%
  mutate( start=timestamp, end=timestamp) %>%
  select( start, end, which, userid) %>%
  nest( .key='surveys') %>% 
  { . } -> df_all_ts_nested

#********************************************************************************
#
#********************************************************************************
analyse_staypoint_set_time <- function( row ) {


  readRDS(row$filename) -> df
  cat(row$filename)
  cat("\n")

  df %>% 
    filter( n_staypoint > 0 ) %>%
    group_by( userid, night, n_staypoint) %>%
    summarise( start=min(time_stamp), end=max(time_stamp), duration=end-start ) %>% 
    group_by( userid ) %>%
    nest( .key='staypoints') %>%
    ungroup() %>%
    inner_join( df_all_ts_nested, by='userid') %>% 
    group_by( userid, night) %>%
    do( joined = interval_inner_join( data.frame(.$surveys), 
                                     data.frame(.$staypoints), 
                                     by=c('start','end'),
                                     maxgap=300))  %>%
  ungroup() %>%
  unnest() %>% 
  { . } -> df_intersect


  df_intersect %>% 
    group_by( userid, night, n_staypoint ) %>% 
    arrange(  duration, which) %>%
    do( head(., 1)) %>%
    ungroup() %>%
    { . } -> df_intersect1

  df_intersect1 %>% 
    count( which, sort=TRUE) %>%
    spread(which, n) %>%
    bind_cols(row) %>%
    bind_cols (enframe( nrow(df_intersect1), value='nsurvey_hits')) %>%
    select( -name )

}


rv %>%
  rowwise () %>%
  do( analyse_staypoint_set_time(.)) %>%
  { . } -> rv1

rv1 %>%
  separate( col=filename, 
           into=c(NA, qc(min_staypoint_time, max_jump_time, max_staypoint_distance, max_speed_filter, NA)), 
           sep='_', 
           remove=FALSE)  %>%
select( min_staypoint_time, max_jump_time, max_staypoint_distance, max_speed_filter, everything() ) %>%
mutate_at(1:4, function(x) {sprintf('%06.1f', as.numeric(x) ) }) %>%
{ . } -> rv1


```

# Reports - Staypoints evaluated according to survey timestamps

```{r}


rv1 %>%
  ggplot( aes(x=(max_jump_time), y=nsurvey_hits, fill=(max_jump_time) )) +
  geom_boxplot() + 
  ggtitle("maximum jump time x Number of survey discoveries")

rv1 %>%
  ggplot( aes(x=(max_staypoint_distance), y=nsurvey_hits, fill=( max_staypoint_distance) )) +
  geom_boxplot()

rv1 %>%
  ggplot( aes(x=(max_speed_filter), y=nsurvey_hits, fill=( max_speed_filter) )) +
  geom_boxplot()

rv1 %>%
  ggplot( aes(x=(min_staypoint_time), y=nsurvey_hits/n_staypoint, fill=( min_staypoint_time) )) +
  geom_boxplot()

rv1 %>%
  ggplot( aes(x=(max_jump_time), y=nsurvey_hits/n_staypoint, fill=(max_jump_time) )) +
  geom_boxplot()

rv1 %>%
  ggplot( aes(x=(max_staypoint_distance), y=nsurvey_hits/n_staypoint, fill=( max_staypoint_distance) )) +
  geom_boxplot()

rv1 %>%
  ggplot( aes(x=(max_speed_filter), y=nsurvey_hits/n_staypoint, fill=( max_speed_filter) )) +
  geom_boxplot()

rv1 %>%
  ggplot( aes(x=(min_staypoint_time), y=nsurvey_hits/n_staypoint, fill=( min_staypoint_time) )) +
  geom_boxplot()


rv1 %>%
  ggplot( aes(x=(min_staypoint_time), y=nsurvey_hits/n_staypoint, fill=( min_staypoint_time) )) +
  geom_boxplot() + 
  facet_wrap( .~max_staypoint_distance)

rv1 %>%
  ggplot( aes(x=(min_staypoint_time), color=max_staypoint_distance, y=( n_staypoint) )) +
  geom_point()

rv1 %>%
  ggplot( aes(x=(min_staypoint_time), color=max_staypoint_distance, y=( nhits / n_staypoint) )) +
  geom_point()

rv1 %>%
  ggplot( aes(x=(min_staypoint_time), color=max_staypoint_distance, y=( nsurvey_hits / n_staypoint) )) +
  geom_point()

rv1 %>%
  ggplot( aes(x=(min_staypoint_time), color=max_staypoint_distance, y=( nhits) )) +
  geom_point()

rv1 %>%
  ggplot( aes(x=(min_staypoint_time), color=max_staypoint_distance, y=(nsurvey_hits ) )) +
  geom_point()

```


```{r mapping}


gps_zurich = tribble( ~id, ~name, ~lat1, ~lon1, ~lat2, ~lon2, 
                      1, 'Zurich-west', 47.392066, 8.514331, 8.522678, 47.384563, 
                      2, 'Langstrasse', 47.384718, 8.522091, 8.533506, 47.369843, 
                      3, 'Gessneralle', 47.377371, 8.529566, 8.541196, 47.36528, 
                      4, 'UmHB', 47.380218, 8.536948, 8.543814, 47.373302, 
                      5, 'Niederdorf', 47.377574, 8.542347, 8.547977, 47.369494, 
                      6, 'Bellevue', 47.369989, 8.541754, 8.551024, 47.361908, 
                      7, 'Seeanlag', 47.364699, 8.534365, 8.539094, 47.357896, 
                      8, 'Shilcity', 47.36246, 8.520597, 8.527077, 47.357605)

gps_lausanne = tribble( ~id, ~name, ~lat1, ~lon1, ~lat2, ~lon2, 
1, 'Riponne-Mudac'          ,46.521375 , 46.524048 , 6.628332 , 6.636465 ,
2, 'Flon'                   ,46.520172 , 46.522254 , 6.625446 , 6.630254 ,
3, 'Europe/Rue Centrale'    ,46.520083 , 46.521375 , 6.630254 , 6.635359 ,
4, 'Caroline'               ,46.519264 , 46.521132 , 6.635683 , 6.639093 ,
5, 'St-Fran�ois'            ,46.517610 , 46.520083 , 6.629051 , 6.635359 ,
6, 'Petit ch�ne/Gare'       ,46.518659 , 46.520083 , 6.633106 , 6.635359 ,
7, 'Montbenon'              ,46.519249 , 46.520622 , 6.624631 , 6.630253 )



```

```{r analyse_both}



#********************************************************************************
#
#********************************************************************************
analyse_staypoint_set_time_and_geography <- function( row ) {


  readRDS(row$filename) -> df
  cat(row$filename)
  cat("\n")

  df %>% 
    filter( n_staypoint > 0 ) %>%
    group_by( userid, night, n_staypoint) %>%
    summarise( start=min(time_stamp), end=max(time_stamp), duration=end-start ) %>% 
    group_by( userid ) %>%
    nest( .key='staypoints') %>%
    ungroup() %>%
    inner_join( df_all_ts_nested, by='userid') %>% 
    group_by( userid) %>%
    do( joined = interval_inner_join( data.frame(.$surveys), 
                                     data.frame(.$staypoints), 
                                     by=c('start','end'),
                                     maxgap=300))  %>%
    ungroup() %>%
    unnest() %>% 
    { . } -> df_intersect_time


  df_intersect %>% 
    group_by( userid, night, n_staypoint ) %>% 
    arrange(  duration, which) %>%
    do( head(., 1)) %>%
    ungroup() %>%
    { . } -> df_intersect_time_cleaned

    df %>% 
      filter( n_staypoint > 0 ) %>%
      group_by( userid, night, n_staypoint) %>%
      summarise( latitude = mean( latitude), longitude  = mean( longitude)) %>% 
      ungroup() %>%
      geo_inner_join(df_4sq_locations_filtered, max_dist = .02, distance_col='dist') %>% 
      { . } -> df_intersect_geo

    df_intersect_geo %>%
      mutate( dist = round( dist * 1000, 0)) %>%
      group_by( userid, night, n_staypoint ) %>% 
      arrange( dist , type) %>%
      do( head(., 1)) %>%
      ungroup() %>%
      { . } -> df_intersect_geo_cleaned


    df_intersect_time_cleaned %>%
      full_join( df_intersect_geo_cleaned, by = qc( userid, night, n_staypoint )) %>% 
      { . } -> df_intersect_both

    df_intersect_both %>%
      count( is.na( start.x), is.na( latitude.x)) %>%
      mutate( hit_count = qc( Both_hits, Time_only_hits, Location_only_hits)) %>%
      select( n, hit_count ) %>%
      spread( hit_count, n ) %>%
      bind_cols( row )
}

rv1 %>%
  rowwise () %>%
  do( analyse_staypoint_set_time_and_geography(.)) %>%
  { . } -> rv2

saveRDS( rv2, 'data/rv2.rds')

```

```{r graph_both}



rv2 %>%
  ggplot( aes(x=(max_jump_time), y=Both_hits, fill=(max_jump_time) )) +
  geom_boxplot() + 
  ggtitle("maximum jump time x Number of survey discoveries")

rv2 %>%
  ggplot( aes(x=(max_staypoint_distance), y=Both_hits, fill=( max_staypoint_distance) )) +
  geom_boxplot()

rv2 %>%
  ggplot( aes(x=(max_speed_filter), y=Both_hits, fill=( max_speed_filter) )) +
  geom_boxplot()

rv2 %>%
  ggplot( aes(x=(min_staypoint_time), y=Both_hits/n_staypoint, fill=( min_staypoint_time) )) +
  geom_boxplot()

rv2 %>%
  ggplot( aes(x=(max_jump_time), y=Both_hits/n_staypoint, fill=(max_jump_time) )) +
  geom_boxplot()

rv2 %>%
  ggplot( aes(x=(max_staypoint_distance), y=Both_hits/n_staypoint, fill=( max_staypoint_distance) )) +
  geom_boxplot()

rv2 %>%
  ggplot( aes(x=(max_speed_filter), y=Both_hits/n_staypoint, fill=( max_speed_filter) )) +
  geom_boxplot()

rv2 %>%
  ggplot( aes(x=(min_staypoint_time), y=Both_hits/n_staypoint, fill=( min_staypoint_time) )) +
  geom_boxplot()


rv2 %>%
  ggplot( aes(x=(min_staypoint_time), y=Both_hits/n_staypoint, fill=( min_staypoint_time) )) +
  geom_boxplot() + 
  facet_wrap( .~max_staypoint_distance)

rv2 %>%
  ggplot( aes(x=(min_staypoint_time), color=max_staypoint_distance, y=( Both_hits / n_staypoint) )) +
  geom_point()

rv2 %>%
  ggplot( aes(x=(min_staypoint_time), color=max_staypoint_distance, y=(Both_hits ) )) +
  geom_point()


```


